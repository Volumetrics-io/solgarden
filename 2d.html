<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Sol Garden</title>
    <style>
        * {
            border: none;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        #root {
            position: absolute;
            /* border: 1px solid red; */
            width: 800px;
            height: 800px;
            top: 50px;
            left: 50px;
        }

        .tile {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>
    <main id="root"></main>

    <script src="heightmap.js"></script>
    <script src="pathfinder.js"></script>
    <script>

        window.onload = () => {

            const scale = 100;

            const comp = {
                rows: 5,
                cols: 5,
                floors: 3
            }

            // player
            window.goal = window.player = {
                x: Math.floor(Math.random() * comp.rows),
                y: Math.floor(Math.random() * comp.cols)
            }

            // goal
            while (window.goal == window.player) {
                window.goal = {
                    x: Math.floor(Math.random() * comp.rows),
                    y: Math.floor(Math.random() * comp.cols)
                }
            }

            const heightMap = Array.from({ length: comp.rows }, (_, x) =>
                Array.from({ length: comp.cols }, (_, y) => Math.floor(smoothNoise(x * 0.5, y * 0.5) * comp.floors))
            );

            const root = document.querySelector('#root');

            // tiles
            const tilemap = [];
            for (let f = 0; f < comp.floors; f++) {
                const floor = [];

                for (let r = 0; r < comp.rows; r++) {
                    const row = [];

                    for (let c = 0; c < comp.cols; c++) {

                        let isTop = (f === heightMap[r][c]);
                        if (f <= heightMap[r][c]) {

                            let tile = document.createElement("div");
                            tile.className = 'tile';
                            let bgColor = (f / comp.floors) * 80 + 20;
                            let bgString = `hsl(200, 10%, ${bgColor}%)`;
                            tile.dataset.bgColor = bgString;
                            Object.assign(tile.style, {
                                position: 'absolute',
                                top: (r * scale + f * 10) + "px",
                                left: (c * scale + f * 10) + "px",
                                height: scale + "px",
                                width: scale + "px",
                                border: `2px solid white`,
                                backgroundColor: bgString,
                                color: `hsl(0, 100%, 100%)`,
                            });
                            tile.dataset.floor = f;
                            tile.innerHTML = f;

                            tile.addEventListener('mouseover', () => {
                                px = window.player.x;
                                py = window.player.y;

                                let canMove = false;
                                if (r + 1 == px && c + 2 == py ||
                                    r + 2 == px && c + 1 == py ||
                                    r + 2 == px && c - 1 == py ||
                                    r + 1 == px && c - 2 == py ||
                                    r - 1 == px && c - 2 == py ||
                                    r - 2 == px && c - 1 == py ||
                                    r - 2 == px && c + 1 == py ||
                                    r - 1 == px && c + 2 == py
                                ) {
                                    canMove = true;
                                }

                                if (canMove) {
                                    tile.style.border = "4px solid green";
                                    tile.style.backgroundColor = "green";
                                } else {
                                    tile.style.border = "4px solid red";
                                    tile.style.backgroundColor = "red";
                                }
                            })

                            tile.addEventListener('mouseout', () => {
                                tile.style.border = "2px solid white";
                                tile.style.backgroundColor = tile.dataset.bgColor;
                            })

                            tile.addEventListener('click', () => {
                                console.log(r, c);

                                px = window.player.x;
                                py = window.player.y;

                                let canMove = false;
                                if (r + 1 == px && c + 2 == py ||
                                    r + 2 == px && c + 1 == py ||
                                    r + 2 == px && c - 1 == py ||
                                    r + 1 == px && c - 2 == py ||
                                    r - 1 == px && c - 2 == py ||
                                    r - 2 == px && c - 1 == py ||
                                    r - 2 == px && c + 1 == py ||
                                    r - 1 == px && c + 2 == py
                                ) {
                                    canMove = true;
                                }

                                if (canMove) {
                                    window.player = {
                                        x: r,
                                        y: c
                                    }

                                    Object.assign(playerTile.style, {
                                        top: (window.player.x * scale + heightMap[window.player.x][window.player.y] * 10 + 10) + "px",
                                        left: (window.player.y * scale + heightMap[window.player.x][window.player.y] * 10 + 10) + "px",
                                    });
                                }
                            })

                            root.append(tile);

                            row.push(tile);
                        }

                    }

                    floor.push(row);
                }

                tilemap.push(floor);

            }

            var playerTile = document.createElement("div");
            playerTile.className = 'tile';
            Object.assign(playerTile.style, {
                position: 'absolute',
                top: (window.player.x * scale + heightMap[window.player.x][window.player.y] * 10 + 10) + "px",
                left: (window.player.y * scale + heightMap[window.player.x][window.player.y] * 10 + 10) + "px",
                height: scale + "px",
                width: scale + "px",
                border: `1px solid red`,
                backgroundColor: `yellow`,
                borderRadius: '50%',
                color: `black`,
                transition: `all .3s ease-in-out`
            });
            playerTile.innerHTML = "Player";
            root.append(playerTile);

            var goalTile = document.createElement("div");
            goalTile.className = 'tile';
            Object.assign(goalTile.style, {
                position: 'absolute',
                top: (window.goal.x * scale + heightMap[window.goal.x][window.goal.y] * 10 + 10) + "px",
                left: (window.goal.y * scale + heightMap[window.goal.x][window.goal.y] * 10 + 10) + "px",
                height: scale + "px",
                width: scale + "px",
                border: `1px solid red`,
                backgroundColor: `green`,
                borderRadius: '50%',
                color: `black`,
                pointerEvents: `none`
            });
            goalTile.innerHTML = "Goal";
            root.append(goalTile);
        }

    </script>
</body>

</html>